<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="'Редактор колажу: ' + ${collage.name}">Редактор колажу</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h4 { color: #333; }
        .upload-section, .layers-section, .render-section { margin-top: 30px; }
        .layer { border: 1px solid #ddd; padding: 15px; margin-top: 15px; border-radius: 5px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .layer img { max-width: 200px; height: auto; border: 1px solid #ccc; align-self: flex-start; }
        .layer-controls { flex-grow: 1; }
        .control-group { margin-top: 15px; }
        .control-group form { display: inline-block; margin-right: 10px; }
        .control-group input[type=number] { width: 70px; padding: 5px; }
        button { background-color: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #2980b9; }
        .btn-delete { background-color: #e74c3c; }
        .btn-delete:hover { background-color: #c0392b; }
        .render-section { background-color: #e8f4fd; padding: 20px; border-radius: 5px; }
        .btn-render { background-color: #28a745; font-size: 16px; padding: 10px 20px; }
        .layer-group-info { background-color: #eaf2f8; padding: 10px; border-radius: 5px; border: 1px dashed #3498db; }
    </style>
</head>
<body>

<div class="container">
    <h1 th:text="'Редактор: ' + ${collage.name}">Редактор: Назва колажу</h1>

    <div class="render-section">
        <h2>Завершення роботи</h2>
        <p>Коли ви закінчите редагування, ви можете зберегти всі шари в одне фінальне зображення.</p>
        <form th:action="@{'/collages/' + ${collage.id} + '/render'}" method="post">
            <button type="submit" class="btn-render">Зберегти фінальний колаж</button>
        </form>
    </div>

    <div class="upload-section">
        <h2>Додати нове зображення</h2>
        <form th:action="@{'/collages/' + ${collage.id} + '/layers/add'}" method="post" enctype="multipart/form-data">
            <input type="file" name="imageFile" accept=".jpg, .jpeg, .png, .gif, .webp" required>
            <button type="submit">Додати в колаж</button>
        </form>
    </div>

    <div class="layers-section">
        <h2>Шари колажу</h2>

        <div th:each="layer : ${collage.layers}" class="layer">

            <div th:if="${layer instanceof T(com.example.imageeditor.domain.ImageLayer)}">
                <div th:with="imgLayer=${layer}">

                    <img th:src="@{'/collages/layers/' + ${imgLayer.id} + '/transformed' + '?v=' + ${#dates.createNow().getTime()}}" alt="Зображення шару">

                    <div class="layer-controls">
                        <div><strong>Шар (Листок) ID:</strong> <span th:text="${imgLayer.id}">1</span></div>
                        <div><strong>Поворот:</strong> <span th:text="${imgLayer.rotationAngle}">0</span>°</div>

                        <div class="control-group">
                            <h4>Undo / Redo</h4>
                            <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${imgLayer.id} + '/undo'}" method="post" style="display: inline-block;">
                                <button type="submit" class="btn-delete">Undo</button>
                            </form>
                            <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${imgLayer.id} + '/redo'}" method="post" style="display: inline-block;">
                                <button type="submit" class="btn-delete">Redo</button>
                            </form>
                        </div>

                        <div class="control-group">
                            <h4>Розтягнути / Стиснути</h4>
                            <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${imgLayer.id} + '/update'}" method="post">
                                Ширина: <input type="number" name="width" th:value="${imgLayer.width}" required>
                                Висота: <input type="number" name="height" th:value="${imgLayer.height}" required>
                                <button type="submit">Змінити розмір</button>
                            </form>
                        </div>

                        <div class="control-group">
                            <h4>Кадрувати (відносно оригіналу)</h4>
                            <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${imgLayer.id} + '/update'}" method="post">
                                X: <input type="number" name="cropX" th:value="${imgLayer.cropX ?: 0}">
                                Y: <input type="number" name="cropY" th:value="${imgLayer.cropY ?: 0}"> <br>
                                Ширина: <input type="number" name="cropWidth" th:value="${imgLayer.cropWidth ?: imgLayer.image.width}">
                                Висота: <input type="number" name="cropHeight" th:value="${imgLayer.cropHeight ?: imgLayer.image.height}">
                                <button type="submit">Застосувати кадрування</button>
                            </form>
                        </div>
                    </div> </div> </div> <div th:if="${layer instanceof T(com.example.imageeditor.domain.LayerGroup)}">
            <div class="layer-group-info">
                <h4>Це Група (ID: <span th:text="${layer.id}"></span>)</h4>
                <p>Дії "Розмір", "Кадрувати" та "Undo/Redo" недоступні для групи.</p>
            </div>
        </div>

            <div class="layer-controls">
                <div class="control-group">
                    <h4>Загальні дії (для Шару або Групи)</h4>
                    <div><strong>ID:</strong> <span th:text="${layer.id}"></span></div>
                    <div><strong>Загальний поворот:</strong> <span th:text="${layer.rotationAngle}">0</span>°</div>

                    <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${layer.id} + '/action'}" method="post" style="display: inline-block;">
                        <input type="hidden" name="action" value="rotate_right">
                        <button type="submit">Повернути на 90</button>
                    </form>
                    <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${layer.id} + '/action'}" method="post" style="display: inline-block;">
                        <input type="hidden" name="action" value="rotate_left">
                        <button type="submit">Повернути на -90</button>
                    </form>
                    <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${layer.id} + '/action'}" method="post" style="display: inline-block;">
                        <input type="hidden" name="action" value="delete">
                        <button type="submit" class="btn-delete">Видалити</button>
                    </form>
                    <form th:action="@{'/collages/' + ${collage.id} + '/layers/' + ${layer.id} + '/clone'}" method="post" style="display: inline-block;">
                        <button type="submit">Клонувати</button>
                    </form>
                </div>
            </div>

        </div> <div th:if="${collage.layers.isEmpty()}">
        <p>У цьому колажі ще немає жодного шару. Завантажте зображення, щоб почати.</p>
    </div>
    </div>
</div>

</body>
</html>